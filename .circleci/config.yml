version: 2.1

workflows: 
  code-commit:
    jobs:
      - black-python-code-formatter:
          context: org-sightmachine
      - mypy-type-checks:
          context: org-sightmachine
      - run-unit-tests:
          context: org-sightmachine

orbs:
  gcp-gke: circleci/gcp-gke@0.2.0
  python: circleci/python@2.1.1
  codecov: codecov/codecov@3.3.0

commands:
  disable_docker_hub:
    description: "Disable Docker Hub access for running container/VM."
    steps:
      - run:
          name: Disable Docker Hub
          command: |
            mkdir -p ~/.docker/
            echo '{"auths":{"https://index.docker.io/v1/":{"auth":"YTpiYWQK"}}}' > ~/.docker/config.json
  disable_build_if_not_pr:
    description: "Stop the current build if not in a PR context."
    steps:
      - run:
          name: Abort if not building a pull request
          command: |
            if [ -z "$CIRCLE_PULL_REQUEST" ]; then
              circleci-agent step halt
            fi


jobs:
  ## ------------------ Run Unit Tests ------------------

  run-unit-tests:
    # Use VM over docker container
    machine:
      # # https://circleci.com/docs/2.0/configuration-reference/#available-machine-images
      # image: ubuntu-2204:2022.07.1
    docker:
      - image: cimg/python:3.11.0
    steps:
      # Make sure that the build doesn't accidentally pull images from Docker Hub.
      # Pulls from Docker Hub may fail due to rate-limiting after Nov 1 2020.
      - disable_docker_hub
      - attach_workspace:
          at: /tmp/workspace

      # - configure_environment
      - checkout
      - python/install-packages:
          pkg-manager: pip
      - run:
          name: Run Unit Tests
          command: |
            set -x
            pip install -r requirements-codecoverage.txt
            pip install .
            mkdir test-results
            coverage run -m pytest --nbmake --nbmake-timeout=300 -n=auto --junitxml=test-results/junit.xml tests examples
      - run:
          name: Compile Coverage Report
          command: |
            coverage html -d htmlcov
            codecov --required

      # Store the test results on each node so we can see failures
      - store_test_results:
          path: test-results
      
      - store_artifacts:
          name: Save Unit Test Results
          path: htmlcov

  ## ------------------ Check Black python code formate ------------------
  black-python-code-formatter:
    parameters:
      with_merge: # Part of the PR-merge workflow
        type: boolean
        default: false
    docker:
      # https://circleci.com/developer/images/image/cimg/python
      - image: cimg/python:3.11.0
    steps:
      - when:
          condition: << parameters.with_merge >>
          steps:
            - disable_build_if_not_pr
      - checkout
      - run:
          name: Run black code formatter check
          command: |
            set -x
            pip install -r ./requirements-black.txt
            black --check .
            if [ $? -ne 0 ]; then
              echo "Unformatted code detected. Please run black --fast . locally and commit to format your code." >&2
              exit 1
            fi

  ## ------------------ Mypy for Static Type Checking python code ------------------
  mypy-type-checks:
    parameters:
      with_merge: # Part of the PR-merge workflow
        type: boolean
        default: false
    docker:
      # https://circleci.com/developer/images/image/cimg/python
      - image: cimg/python:3.11.0
    steps:
      - when:
          condition: << parameters.with_merge >>
          steps:
            - disable_build_if_not_pr
      - checkout
      # Run Pyre type checking
      - run:
          name: Run Static type checking
          command: |
            set -x
            # Install Python packages for type checking
            pip wheel --wheel-dir=./wheel-dir -r requirements-type-checks.txt
            pip install --find-links=./wheel-dir -r requirements-type-checks.txt
            # Using 'git diff ...' to fetch newly added Python files from the repo
            # Conducting static type checking on the files obtained
            # Re-running static type checking on the files listed in 'mypy.ini'
            mypy $(git diff --name-only --diff-filter=A origin/master HEAD | grep '\.py$') && mypy
            if [ $? -ne 0 ]; then
                echo "MyPy finds static type error(s) in the Python codebase. Please fix all type-related errors before committing the code." >&2
                exit 1
            fi
      # Store MyPy type checking results
      - store_test_results:
          path: mypy-results
      # Store MyPy type checking artifacts (e.g., HTML reports)
      - store_artifacts:
          name: MyPy Artifacts
          path: mypy-results/mypy-html
